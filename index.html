<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WeatherWary.Earth - Recommender</title>
  <style>
    body {
      margin: 0; font-family: "Inter", Arial, sans-serif; height: 100vh;
      display: flex; flex-direction: row; justify-content: space-between; align-items: center;
      background-color: #0f1724; color: #e6eef6; overflow: hidden;
    }
    .panel {
      flex: 1; height: 100%; display: flex; flex-direction: column;
      justify-content: center; align-items: center; box-sizing: border-box; padding: 30px;
    }
    #left-panel { background-color: #0b1220; border-right: 1px solid rgba(255,255,255,0.05); }
    #center-panel { background: radial-gradient(circle at center, #152338, #0f1724); }
    #right-panel { background-color: #0b1220; border-left: 1px solid rgba(255,255,255,0.05); }
    #map { width: 130%; height: 80%; border-radius: 20px; overflow: hidden; box-shadow: 0 0 25px rgba(0,0,0,0.3); }
    h2 { color: #46b3ff; margin-bottom: 20px; }
    label { display: block; margin-top: 10px; color: #9aa6b2; font-size: 14px; }
    input[type="date"], input[type="text"], select {
      width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: none;
      background: rgba(255,255,255,0.1); color: #e6eef6;
    }
    select option { background: #0b1220; }
    button {
      margin-top: 20px; padding: 10px 14px; border-radius: 8px;
      background: linear-gradient(90deg,#46b3ff,#2bd0a6); color: #022; font-weight: bold; border: none; cursor: pointer; width: 100%;
    }
    /* --- MODIFIED: Styling for the unified results list --- */
    #results-list {
      list-style: none; padding: 0; margin: 0; width: 90%; height: 70vh; /* Taller list */
      overflow-y: auto;
    }
    .result-item {
      padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;
      background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;
    }
    .result-item:hover { background: rgba(70,179,255,0.2); }
    .place-name { font-weight: bold; flex-grow: 1; }
    .weather-info { text-align: right; white-space: nowrap; }
    .weather-info span { display: block; font-size: 0.85em; color: #9aa6b2; }
    .date-range { display: flex; gap: 8px; width: 100%; }
  </style>
</head>
<body>
  <!-- LEFT: Search tools -->
  <div class="panel" id="left-panel">
    <div style="width:80%; max-width:300px;">
      <h2>Discover & Plan</h2>
      <label for="citySearch">Search for a City</label>
      <input id="citySearch" type="text" placeholder="e.g., Paris, France" />
      <label for="activity">Select Activity</label>
      <select id="activity">
        <option value="hiking trails">Hiking</option>
        <option value="beaches">Beaches</option>
        <option value="ski resorts">Skiing</option>
        <option value="fishing spots">Fishing</option>
        <option value="museums">Museums</option>
        <option value="castles">Castles</option>
        <option value="national parks">National Parks</option>
      </select>
      <label>Date Range for Weather</label>
      <div class="date-range">
        <input id="fromDate" type="date" />
        <input id="toDate" type="date" />
      </div>
      <button id="findPlaces">Find Places & Weather</button>
    </div>
  </div>

  <!-- CENTER: Map -->
  <div class="panel" id="center-panel">
    <div id="map"></div>
  </div>

  <!-- RIGHT: Results -->
  <div class="panel" id="right-panel">
    <div style="width:80%;max-width:400px;display:flex;flex-direction:column;align-items:center;">
      <h2>Results</h2>
      <!-- --- MODIFIED: One single list for combined results --- -->
      <ul id="results-list"></ul>
    </div>
  </div>

<script>
    let map, service, markers = [];
    let state = { searchCenter: null };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 2, center: { lat: 20, lng: 0 },
            mapTypeControl: false, streetViewControl: false,
        });
        service = new google.maps.places.PlacesService(map);

        const citySearchInput = document.getElementById('citySearch');
        const autocomplete = new google.maps.places.Autocomplete(citySearchInput, { types: ['(cities)'] });
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                alert("No details available for input: '" + place.name + "'");
                return;
            }
            map.setCenter(place.geometry.location);
            map.setZoom(10);
            state.searchCenter = place.geometry.location;
        });
        document.getElementById("findPlaces").addEventListener("click", findPlacesAndWeather);
    }

    async function findPlacesAndWeather() {
        if (!state.searchCenter) { alert("Please search for and select a city first."); return; }
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        if (!fromDate || !toDate) { alert("Please select a start and end date."); return; }

        const activity = document.getElementById("activity").value;
        const resultsList = document.getElementById("results-list");
        
        markers.forEach(m => m.setMap(null));
        markers = [];
        resultsList.innerHTML = "<li>Searching for places...</li>";

        const request = { location: state.searchCenter, radius: 50000, query: activity, fields: ["name", "geometry", "formatted_address"] };

        service.textSearch(request, async (places, status) => {
            if (status !== google.maps.places.PlacesServiceStatus.OK || !places || places.length === 0) {
                resultsList.innerHTML = "<li>No results found.</li>";
                return;
            }

            resultsList.innerHTML = `<li>Found ${places.length} places. Fetching weather data...</li>`;

            try {
                // Create an array of promises, one for each weather data fetch
                const weatherPromises = places.map(place => {
                    const loc = place.geometry.location;
                    const lat = typeof loc.lat === 'function' ? loc.lat() : loc.lat;
                    const lng = typeof loc.lng === 'function' ? loc.lng() : loc.lng;
                    
                    const parameters = "t_2m:C,precip_1h:mm"; // Only fetch temp and precip
                    const startISO = new Date(fromDate).toISOString().split('T')[0] + "T00:00:00Z";
                    const endISO = new Date(toDate).toISOString().split('T')[0] + "T23:59:00Z";
                    const url = `/api/getWeather?lat=${lat}&lng=${lng}&startISO=${startISO}&endISO=${endISO}&parameters=${parameters}`;
                    
                    return fetch(url).then(res => res.json());
                });

                // Wait for ALL weather requests to complete
                const weatherResults = await Promise.all(weatherPromises);

                resultsList.innerHTML = ""; // Clear list for final results

                // Now, combine the places and weather data to build the final list
                places.forEach((place, index) => {
                    const weatherData = weatherResults[index];
                    const averages = calculateWeatherAverages(weatherData);
                    createUnifiedListItemAndMarker(place, averages);
                });

            } catch (error) {
                resultsList.innerHTML = `<li>Error fetching weather data: ${error.message}</li>`;
                console.error("Error during weather fetch:", error);
            }
        });
    }

    function calculateWeatherAverages(weatherData) {
        if (!weatherData || !weatherData.data || weatherData.status !== "OK") {
            return { avgTemp: 'N/A', avgPrecip: 'N/A' };
        }
        
        let tempSum = 0, precipSum = 0, tempCount = 0, precipCount = 0;
        
        // Find temperature parameter
        const tempParam = weatherData.data.find(p => p.parameter === 't_2m:C');
        if (tempParam) {
            const values = tempParam.coordinates[0].dates;
            values.forEach(v => { tempSum += v.value; tempCount++; });
        }

        // Find precipitation parameter
        const precipParam = weatherData.data.find(p => p.parameter === 'precip_1h:mm');
        if (precipParam) {
            const values = precipParam.coordinates[0].dates;
            values.forEach(v => { precipSum += v.value; precipCount++; });
        }

        return {
            avgTemp: tempCount > 0 ? (tempSum / tempCount).toFixed(1) : 'N/A',
            avgPrecip: precipCount > 0 ? (precipSum / precipCount).toFixed(2) : 'N/A'
        };
    }

    function createUnifiedListItemAndMarker(place, weatherAverages) {
        // Create Map Marker
        const marker = new google.maps.Marker({
            position: place.geometry.location, map, title: place.name
        });
        markers.push(marker);

        // Create Unified List Item
        const li = document.createElement("li");
        li.className = 'result-item';
        li.innerHTML = `
            <div class="place-name">${place.name}</div>
            <div class="weather-info">
                ${weatherAverages.avgTemp}Â°C
                <span>Avg. Temp</span>
            </div>
            <div class="weather-info" style="margin-left: 15px;">
                ${weatherAverages.avgPrecip} mm
                <span>Avg. Precip</span>
            </div>
        `;
        document.getElementById("results-list").appendChild(li);

        // Add interaction to pan to marker on click
        li.addEventListener('click', () => {
            map.panTo(place.geometry.location);
            map.setZoom(12);
        });
    }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkk5aRWm5Yr_X9GhJIjljLgVL9jXlZ_0k&libraries=places&callback=initMap"></script>
</body>
</html>
